
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>arxiv.submission.domain.event &#8212; arXiv submission &amp; moderation 0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for arxiv.submission.domain.event</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Data structures for submissions events.</span>

<span class="sd">- Events have unique identifiers generated from their data (creation, agent,</span>
<span class="sd">  submission).</span>
<span class="sd">- Events provide methods to update a submission based on the event data.</span>
<span class="sd">- Events provide validation methods for event data.</span>

<span class="sd">Writing new events/commands</span>
<span class="sd">===========================</span>

<span class="sd">Events/commands are implemented as classes that inherit from :class:`.Event`.</span>
<span class="sd">It should:</span>

<span class="sd">- Be a dataclass (i.e. be decorated with :func:`dataclasses.dataclass`).</span>
<span class="sd">- Define (using :func:`dataclasses.field`) associated data.</span>
<span class="sd">- Implement a validation method with the signature</span>
<span class="sd">  ``validate(self, submission: Submission) -&gt; None`` (see below).</span>
<span class="sd">- Implement a projection method with the signature</span>
<span class="sd">  ``project(self, submission: Submission) -&gt; Submission:`` that mutates</span>
<span class="sd">  the passed :class:`.domain.submission.Submission` instance.</span>
<span class="sd">  The projection *must not* generate side-effects, because it will be called</span>
<span class="sd">  any time we are generating the state of a submission. If you need to</span>
<span class="sd">  generate a side-effect, see :ref:`callbacks`\.</span>
<span class="sd">- Be fully documented. Be sure that the class docstring fully describes the</span>
<span class="sd">  meaning of the event/command, and that both public and private methods have</span>
<span class="sd">  at least a summary docstring.</span>
<span class="sd">- Have a corresponding :class:`unittest.TestCase` in</span>
<span class="sd">  :mod:`arxiv.submission.domain.tests.test_events`.</span>

<span class="sd">Adding validation to events</span>
<span class="sd">===========================</span>

<span class="sd">Each command/event class should implement an instance method</span>
<span class="sd">``validate(self, submission: Submission) -&gt; None`` that raises</span>
<span class="sd">:class:`.InvalidEvent` exceptions if the data on the event instance is not</span>
<span class="sd">valid.</span>

<span class="sd">For clarity, it&#39;s a good practice to individuate validation steps as separate</span>
<span class="sd">private instance methods, and call them from the public ``validate`` method.</span>
<span class="sd">This makes it easier to identify which validation criteria are being applied,</span>
<span class="sd">in what order, and what those criteria mean.</span>

<span class="sd">See :class:`.SetPrimaryClassification` for an example.</span>

<span class="sd">We could consider standalone validation functions for validation checks that</span>
<span class="sd">are performed on several event types (instead of just private instance</span>
<span class="sd">methods).</span>

<span class="sd">.. _callbacks:</span>

<span class="sd">Registering event callbacks</span>
<span class="sd">===========================</span>

<span class="sd">The base :class:`Event` provides support for callbacks that are executed when</span>
<span class="sd">an event instance is committed. To attach a callback to an event type, use the</span>
<span class="sd">:func:`Event.bind` decorator. For example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   @SetTitle.bind()</span>
<span class="sd">   def do_this_when_a_title_is_set(event, before, after, agent):</span>
<span class="sd">       ...</span>
<span class="sd">       return []</span>


<span class="sd">Callbacks must have the signature ``(event: Event, before: Submission,</span>
<span class="sd">after: Submission, creator: Agent) -&gt; Iterable[Event]``. ``event`` is the</span>
<span class="sd">event instance being committed that triggered the callback. ``before`` and</span>
<span class="sd">``after`` are the states of the submission before and after the event was</span>
<span class="sd">applied, respectively. ``agent`` is the agent responsible for any subsequent</span>
<span class="sd">events created by the callback, and should be used for that purpose.</span>

<span class="sd">The callback should not concern itself with persistence; that is handled by</span>
<span class="sd">:func:`Event.commit`. Any mutations of submission should be made by returning</span>
<span class="sd">the appropriate command/event instances.</span>

<span class="sd">The circumstances under which the callback is executed can be controlled by</span>
<span class="sd">passing a condition callable to the decorator. This should have the signature</span>
<span class="sd">``(event: Event, before: Submission, after: Submission, creator: Agent) -&gt;</span>
<span class="sd">bool``; if it returns ``True``, the  callback will be executed. For example:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">   @SetTitle.bind(condition=lambda e, b, a, c: e.title == &#39;foo&#39;)</span>
<span class="sd">   def do_this_when_a_title_is_set_to_foo(event, before, after, agent):</span>
<span class="sd">       ...</span>
<span class="sd">       return []</span>


<span class="sd">When do things actually happen?</span>
<span class="sd">-------------------------------</span>
<span class="sd">Callbacks are triggered when the :func:`.commit` method is called,</span>
<span class="sd">usually by :func:`.core.save`. Normally, any event instances returned</span>
<span class="sd">by the callback are applied and committed right away, in order.</span>

<span class="sd">Setting :mod:`.config.ENABLE_CALLBACKS=0` will disable callbacks</span>
<span class="sd">entirely.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">UTC</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span>\
    <span class="n">Callable</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="k">import</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">bleach</span>

<span class="kn">from</span> <span class="nn">arxiv.util</span> <span class="k">import</span> <span class="n">schema</span>
<span class="kn">from</span> <span class="nn">arxiv</span> <span class="k">import</span> <span class="n">taxonomy</span>
<span class="kn">from</span> <span class="nn">arxiv</span> <span class="k">import</span> <span class="n">identifier</span> <span class="k">as</span> <span class="n">arxiv_identifier</span>
<span class="kn">from</span> <span class="nn">arxiv.base</span> <span class="k">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">arxiv.base.globals</span> <span class="k">import</span> <span class="n">get_application_config</span>

<span class="kn">from</span> <span class="nn">..agent</span> <span class="k">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">agent_factory</span>
<span class="kn">from</span> <span class="nn">..submission</span> <span class="k">import</span> <span class="n">Submission</span><span class="p">,</span> <span class="n">SubmissionMetadata</span><span class="p">,</span> <span class="n">Author</span><span class="p">,</span> \
    <span class="n">Classification</span><span class="p">,</span> <span class="n">License</span><span class="p">,</span> <span class="n">Delegation</span><span class="p">,</span>  \
    <span class="n">SubmissionContent</span><span class="p">,</span> <span class="n">WithdrawalRequest</span><span class="p">,</span> <span class="n">CrossListClassificationRequest</span>
<span class="kn">from</span> <span class="nn">..annotation</span> <span class="k">import</span> <span class="n">Comment</span><span class="p">,</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">ClassifierResults</span><span class="p">,</span> \
    <span class="n">ClassifierResult</span>

<span class="kn">from</span> <span class="nn">...exceptions</span> <span class="k">import</span> <span class="n">InvalidEvent</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="k">import</span> <span class="n">get_tzaware_utc_now</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">event_factory</span><span class="p">,</span> <span class="n">EventType</span>
<span class="kn">from</span> <span class="nn">.request</span> <span class="k">import</span> <span class="n">RequestCrossList</span><span class="p">,</span> <span class="n">RequestWithdrawal</span><span class="p">,</span> <span class="n">ApplyRequest</span><span class="p">,</span> \
    <span class="n">RejectRequest</span><span class="p">,</span> <span class="n">ApproveRequest</span><span class="p">,</span> <span class="n">CancelRequest</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">.proposal</span> <span class="k">import</span> <span class="n">AddProposal</span><span class="p">,</span> <span class="n">RejectProposal</span><span class="p">,</span> <span class="n">AcceptProposal</span>
<span class="kn">from</span> <span class="nn">.flag</span> <span class="k">import</span> <span class="n">AddMetadataFlag</span><span class="p">,</span> <span class="n">AddUserFlag</span><span class="p">,</span> <span class="n">AddContentFlag</span><span class="p">,</span> <span class="n">RemoveFlag</span><span class="p">,</span> \
    <span class="n">AddHold</span><span class="p">,</span> <span class="n">RemoveHold</span>
<span class="kn">from</span> <span class="nn">.process</span> <span class="k">import</span> <span class="n">AddProcessStatus</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Events related to the creation of a new submission.</span>
<span class="c1">#</span>
<span class="c1"># These are largely the domain of the metadata API, and the submission UI.</span>


<div class="viewcode-block" id="CreateSubmission"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmission">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">CreateSubmission</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creation of a new :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;create submission&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission created&quot;</span>

<div class="viewcode-block" id="CreateSubmission.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmission.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate creation of a submission.&quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="CreateSubmission.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmission.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Submission</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
                          <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span>
                          <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CreateSubmissionVersion"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmissionVersion">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateSubmissionVersion</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a new version of a submission.</span>

<span class="sd">    Takes the submission back to &quot;working&quot; state; the user or client may make</span>
<span class="sd">    additional changes before finalizing the submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;create a new version&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;new version created&quot;</span>

<div class="viewcode-block" id="CreateSubmissionVersion.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmissionVersion.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Only applies to announced submissions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_announced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Must already be announced&quot;</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">no_active_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="CreateSubmissionVersion.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.CreateSubmissionVersion.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Increment the version number, and reset several fields.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">WORKING</span>
        <span class="c1"># Return these to default.</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">status</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">source_content</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">license</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_is_author</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">submitter_is_author</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_contact_verified</span> <span class="o">=</span> \
            <span class="n">Submission</span><span class="o">.</span><span class="n">submitter_contact_verified</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_accepts_policy</span> <span class="o">=</span> \
            <span class="n">Submission</span><span class="o">.</span><span class="n">submitter_accepts_policy</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> \
            <span class="n">Submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="Rollback"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Rollback">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Rollback</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Roll back to the most recent announced version, or delete.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;roll back or delete&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;rolled back or deleted&quot;</span>

<div class="viewcode-block" id="Rollback.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Rollback.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Only applies to submissions in an unannounced state.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_announced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Cannot already be announced&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">versions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;No announced version to which to revert&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rollback.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Rollback.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decrement the version number, and reset fields.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">DELETED</span>
            <span class="k">return</span> <span class="n">submission</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">versions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Return these to last announced state.</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">status</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">source_content</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_contact_verified</span> <span class="o">=</span> \
            <span class="n">target</span><span class="o">.</span><span class="n">submitter_contact_verified</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_accepts_policy</span> <span class="o">=</span> \
            <span class="n">target</span><span class="o">.</span><span class="n">submitter_accepts_policy</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> \
            <span class="n">target</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">license</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="ConfirmContactInformation"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmContactInformation">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ConfirmContactInformation</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Submitter has verified their contact information.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;confirm contact information&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;contact information confirmed&quot;</span>

<div class="viewcode-block" id="ConfirmContactInformation.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmContactInformation.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cannot apply to a finalized submission.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfirmContactInformation.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmContactInformation.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update :attr:`.Submission.submitter_contact_verified`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_contact_verified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="ConfirmAuthorship"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmAuthorship">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">ConfirmAuthorship</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The submitting user asserts whether they are an author of the paper.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;confirm that submitter is an author&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submitter authorship status confirmed&quot;</span>

    <span class="n">submitter_is_author</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ConfirmAuthorship.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmAuthorship.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cannot apply to a finalized submission.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfirmAuthorship.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmAuthorship.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the authorship flag on the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_is_author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitter_is_author</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="ConfirmPolicy"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPolicy">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ConfirmPolicy</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The submitting user accepts the arXiv submission policy.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;confirm policy acceptance&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;policy acceptance confirmed&quot;</span>

<div class="viewcode-block" id="ConfirmPolicy.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPolicy.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cannot apply to a finalized submission.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfirmPolicy.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPolicy.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the policy flag on the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_accepts_policy</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="SetPrimaryClassification"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetPrimaryClassification">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetPrimaryClassification</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the primary classification of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;set primary classification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;primary classification set&quot;</span>

    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="SetPrimaryClassification.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetPrimaryClassification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the primary classification category.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">must_be_a_valid_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_creator_must_be_endorsed</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must_be_unannounced</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">cannot_be_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_must_be_unannounced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Can only be set on the first version before publication.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">arxiv_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Can only be set on the first version,&quot;</span>
                                     <span class="s2">&quot; before publication.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_creator_must_be_endorsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creator of this event must be endorsed for the category.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">CATEGORIES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;in_archive&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">endorsements</span> \
                <span class="ow">and</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{archive}</span><span class="s1">.*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">endorsements</span> \
                <span class="ow">and</span> <span class="s1">&#39;*.*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">endorsements</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Creator is not endorsed for&quot;</span>
                                     <span class="n">f</span><span class="s2">&quot; </span><span class="si">{self.category}</span><span class="s2">.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetPrimaryClassification.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetPrimaryClassification.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`.domain.Submission.primary_classification`.&quot;&quot;&quot;</span>
        <span class="n">clsn</span> <span class="o">=</span> <span class="n">Classification</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">primary_classification</span> <span class="o">=</span> <span class="n">clsn</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that we have an :class:`arxiv.taxonomy.Category`.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetPrimaryClassification</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span></div>


<div class="viewcode-block" id="AddSecondaryClassification"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddSecondaryClassification">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">AddSecondaryClassification</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a secondary :class:`.Classification` to a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;add cross-list classification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;cross-list classification added&quot;</span>

    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="AddSecondaryClassification.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddSecondaryClassification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the secondary classification category to add.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">must_be_a_valid_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">cannot_be_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">cannot_be_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddSecondaryClassification.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddSecondaryClassification.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a :class:`.Classification` as a secondary classification.&quot;&quot;&quot;</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="n">Classification</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">secondary_classification</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that we have an :class:`arxiv.taxonomy.Category`.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AddSecondaryClassification</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span></div>


<div class="viewcode-block" id="RemoveSecondaryClassification"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.RemoveSecondaryClassification">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">RemoveSecondaryClassification</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove secondary :class:`.Classification` from submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;remove cross-list classification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;cross-list classification removed&quot;</span>

    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="RemoveSecondaryClassification.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.RemoveSecondaryClassification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the secondary classification category to remove.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">must_be_a_valid_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must_already_be_present</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="RemoveSecondaryClassification.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.RemoveSecondaryClassification.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove from :attr:`.Submission.secondary_classification`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">secondary_classification</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">classn</span> <span class="k">for</span> <span class="n">classn</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">secondary_classification</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">classn</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_must_already_be_present</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;One cannot remove a secondary that is not actually set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">submission</span><span class="o">.</span><span class="n">secondary_categories</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;No such category on submission&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SetLicense"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetLicense">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetLicense</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The submitter has selected a license for their submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;select distribution license&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;distribution license selected&quot;</span>

    <span class="n">license_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">license_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="SetLicense.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetLicense.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the selected license.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetLicense.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetLicense.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`.domain.Submission.license`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="n">License</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">license_name</span><span class="p">,</span>
            <span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">license_uri</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="SetTitle"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetTitle">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetTitle</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the title of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update title&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;title updated&quot;</span>

    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">MIN_LENGTH</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">240</span>
    <span class="n">ALLOWED_HTML</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;br&quot;</span><span class="p">,</span> <span class="s2">&quot;sup&quot;</span><span class="p">,</span> <span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="s2">&quot;hr&quot;</span><span class="p">,</span> <span class="s2">&quot;em&quot;</span><span class="p">,</span> <span class="s2">&quot;strong&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetTitle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

<div class="viewcode-block" id="SetTitle.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetTitle.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the title value.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_does_not_contain_html_escapes</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acceptable_length</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">no_trailing_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Title must not be all-caps&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_html</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetTitle.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetTitle.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the title on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_does_not_contain_html_escapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The title must not contain HTML escapes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&amp;(?:[a-z]{3,4}|#x?[0-9a-f]{1,4})\;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Title may not contain HTML escapes&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_acceptable_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify that the title is an acceptable length.&quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_LENGTH</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Title must be between </span><span class="si">{self.MIN_LENGTH}</span><span class="s2">&quot;</span>
                                     <span class="n">f</span><span class="s2">&quot; and </span><span class="si">{self.MAX_LENGTH}</span><span class="s2"> characters&quot;</span><span class="p">)</span>

    <span class="c1"># In classic, this is only an admin post-hoc check.</span>
    <span class="k">def</span> <span class="nf">_check_for_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for disallowed HTML.&quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">N_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bleach</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ALLOWED_HTML</span><span class="p">,</span>
                                   <span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">N_after</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Title contains unacceptable HTML tags&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetTitle.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetTitle.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform some light tidying on the title.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>       <span class="c1"># Single spaces only.</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetAbstract"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAbstract">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetAbstract</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the abstract of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update abstract&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;abstract updated&quot;</span>

    <span class="n">abstract</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">MIN_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">1920</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetAbstract</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abstract</span><span class="p">)</span>

<div class="viewcode-block" id="SetAbstract.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAbstract.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the abstract value.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acceptable_length</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetAbstract.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAbstract.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the abstract on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abstract</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_acceptable_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abstract</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_LENGTH</span> <span class="ow">or</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">f</span><span class="s2">&quot;Abstract must be between </span><span class="si">{self.MIN_LENGTH}</span><span class="s2">&quot;</span>
                               <span class="n">f</span><span class="s2">&quot; and </span><span class="si">{self.MAX_LENGTH}</span><span class="s2"> characters&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetAbstract.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAbstract.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform some light tidying on the abstract.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>   <span class="c1"># Remove leading or trailing spaces</span>
        <span class="c1"># Tidy paragraphs which should be indicated with &quot;\n  &quot;.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ]+\n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Newline with no following space is removed, so treated as just a</span>
        <span class="c1"># space in paragraph.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\S)\n(\S)&quot;</span><span class="p">,</span> <span class="s2">&quot;\g&lt;1&gt; \g&lt;2&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Tab-&gt;space, multiple spaces-&gt;space.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\t&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;!\n)[ ]{2,}&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Remove tex return (\\) at end of line or end of abstract.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*</span><span class="se">\\\\</span><span class="s2">(\n|$)&quot;</span><span class="p">,</span> <span class="s2">&quot;\g&lt;1&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Remove lone period.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\.\n&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\.$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetDOI"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetDOI">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetDOI</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the external DOI of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;add a DOI&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;DOI added&quot;</span>

    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetDOI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doi</span><span class="p">)</span>

<div class="viewcode-block" id="SetDOI.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetDOI.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the DOI value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Submission</span><span class="o">.</span><span class="n">SUBMITTED</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_announced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Cannot edit a finalized submission&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>    <span class="c1"># Can be blank.</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[;,]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doi</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_doi</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Invalid DOI: </span><span class="si">{value}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetDOI.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetDOI.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the doi on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doi</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_valid_doi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^10\.\d{4,5}\/\S+$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="SetDOI.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetDOI.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform some light tidying on the title.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>        <span class="c1"># Single spaces only.</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetMSCClassification"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetMSCClassification">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetMSCClassification</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the MSC classification codes of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update MSC classification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;MSC classification updated&quot;</span>

    <span class="n">msc_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">160</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetMSCClassification</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msc_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msc_class</span><span class="p">)</span>

<div class="viewcode-block" id="SetMSCClassification.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetMSCClassification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the MSC classification value.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">msc_class</span><span class="p">:</span>    <span class="c1"># Blank values are OK.</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="SetMSCClassification.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetMSCClassification.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the MSC classification on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">msc_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msc_class</span>
        <span class="k">return</span> <span class="n">submission</span></div>

<div class="viewcode-block" id="SetMSCClassification.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetMSCClassification.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform some light fixes on the MSC classification value.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*\.[\s.]*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>     <span class="c1"># No semicolons, should be comma.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*,\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>     <span class="c1"># Want: comma, space.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^MSC([\s:\-]{0,4}(classification|class|number))?&quot;</span>
                       <span class="sa">r</span><span class="s2">&quot;([\s:\-]{0,4}\(?2000\)?)?[\s:\-]*&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetACMClassification"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetACMClassification">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetACMClassification</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the ACM classification codes of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update ACM classification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;ACM classification updated&quot;</span>

    <span class="n">acm_class</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;E.g. F.2.2; I.2.7&quot;&quot;&quot;</span>

    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">160</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetACMClassification</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acm_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acm_class</span><span class="p">)</span>

<div class="viewcode-block" id="SetACMClassification.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetACMClassification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the ACM classification value.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">acm_class</span><span class="p">:</span>    <span class="c1"># Blank values are OK.</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_valid_acm_class</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetACMClassification.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetACMClassification.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the ACM classification on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">acm_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acm_class</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_valid_acm_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check that the value is a valid ACM class.&quot;&quot;&quot;</span>
        <span class="n">ptn</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[A-K]\.[0-9m](\.(\d{1,2}|m)(\.[a-o])?)?$&quot;</span>
        <span class="k">for</span> <span class="n">acm_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acm_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ptn</span><span class="p">,</span> <span class="n">acm_class</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Not a valid ACM class: </span><span class="si">{acm_class}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetACMClassification.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetACMClassification.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform light cleanup.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*\.[\s.]*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^ACM-class:\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([A-K])(\d)&quot;</span><span class="p">,</span> <span class="s2">&quot;\g&lt;1&gt;.\g&lt;2&gt;&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;M$&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetJournalReference"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetJournalReference">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetJournalReference</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the journal reference of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;add a journal reference&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;journal reference added&quot;</span>

    <span class="n">journal_ref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetJournalReference</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span><span class="p">)</span>

<div class="viewcode-block" id="SetJournalReference.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetJournalReference.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the journal reference value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span><span class="p">:</span>    <span class="c1"># Blank values are OK.</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_disallowed_words</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contains_valid_year</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetJournalReference.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetJournalReference.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the journal reference on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">journal_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_no_disallowed_words</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Certain words are not permitted.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;in press&#39;</span><span class="p">,</span> <span class="s1">&#39;appear&#39;</span><span class="p">,</span> <span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;to be publ&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">f</span><span class="s2">&quot;The word &#39;</span><span class="si">{word}</span><span class="s2">&#39; should appear in the&quot;</span>
                                   <span class="n">f</span><span class="s2">&quot; comments, not the Journal ref&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_contains_valid_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Must contain a valid year.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\A|\D)(19|20)\d\d(\D|\Z)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_ref</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Journal reference must include a year&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetJournalReference.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetJournalReference.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform light cleanup.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;PHYSICAL REVIEW LETTERS&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Physical Review Letters&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;PHYSICAL REVIEW&#39;</span><span class="p">,</span> <span class="s1">&#39;Physical Review&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;OPTICS LETTERS&#39;</span><span class="p">,</span> <span class="s1">&#39;Optics Letters&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetReportNumber"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetReportNumber">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetReportNumber</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the report number of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update report number&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;report number updated&quot;</span>

    <span class="n">report_num</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetReportNumber</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_num</span><span class="p">)</span>

<div class="viewcode-block" id="SetReportNumber.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetReportNumber.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the report number value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_num</span><span class="p">:</span>    <span class="c1"># Blank values are OK.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d\d&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_num</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Report number must contain two&quot;</span>
                                     <span class="s2">&quot; consecutive digits&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetReportNumber.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetReportNumber.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set report number on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">report_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_num</span>
        <span class="k">return</span> <span class="n">submission</span></div>

<div class="viewcode-block" id="SetReportNumber.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetReportNumber.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Light cleanup on report number value.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*\.[\s.]*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetComments"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetComments">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetComments</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the comments of a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update comments&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;comments updated&quot;</span>

    <span class="n">comments</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">400</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform some light cleanup on the provided value.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetComments</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span>

<div class="viewcode-block" id="SetComments.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetComments.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the comments value.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>    <span class="c1"># Blank values are OK.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Comments must be no more than&quot;</span>
                                     <span class="n">f</span><span class="s2">&quot; </span><span class="si">{self.MAX_LENGTH}</span><span class="s2"> characters long&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetComments.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetComments.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the comments on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span>
        <span class="k">return</span> <span class="n">submission</span></div>

<div class="viewcode-block" id="SetComments.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetComments.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Light cleanup on comment value.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*\.[\s.]*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="SetAuthors"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAuthors">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetAuthors</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the authors on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update authors&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;authors updated&quot;</span>

    <span class="n">authors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Author</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">authors_display</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The authors string may be provided.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Autogenerate and/or clean display names.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetAuthors</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">Author</span><span class="p">(</span><span class="o">**</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">else</span> <span class="n">a</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_canonical_author_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span><span class="p">)</span>

<div class="viewcode-block" id="SetAuthors.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAuthors.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;May not apply to a finalized submission.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_does_not_contain_et_al</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_canonical_author_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Canonical representation of authors, using display names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">au</span><span class="o">.</span><span class="n">display</span> <span class="k">for</span> <span class="n">au</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">])</span>

<div class="viewcode-block" id="SetAuthors.cleanup"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAuthors.cleanup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform some light tidying on the provided author string(s).&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>          <span class="c1"># Single spaces only.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;,(\s*,)+&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>     <span class="c1"># Remove double commas.</span>
        <span class="c1"># Add spaces between word and opening parenthesis.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\w)\(&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\g&lt;1&gt; (&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="c1"># Add spaces between closing parenthesis and word.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\)(\w)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;) \g&lt;1&gt;&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="c1"># Change capitalized or uppercase `And` to `and`.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bA(?i:ND)\b&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>   <span class="c1"># Removing leading and trailing whitespace.</span></div>

    <span class="k">def</span> <span class="nf">_does_not_contain_et_al</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The authors display value should not contain `et al`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span> <span class="ow">and</span> \
                <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;et al\.?($|\s*\()&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Authors should not contain et al.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SetAuthors.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetAuthors.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace :attr:`.Submission.metadata.authors`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">authors_display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors_display</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="SetUploadPackage"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetUploadPackage">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">SetUploadPackage</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the upload workspace for this submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;set the upload package&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;upload package set&quot;</span>

    <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">uncompressed_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">compressed_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">source_format</span><span class="p">:</span> <span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span> <span class="o">=</span> \
        <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make sure that `source_format` is an enum instance.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SetUploadPackage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_format</span> <span class="o">=</span> <span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_format</span><span class="p">)</span>

<div class="viewcode-block" id="SetUploadPackage.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetUploadPackage.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data for :class:`.SetUploadPackage`.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Missing upload ID&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SetUploadPackage.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.SetUploadPackage.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace :class:`.SubmissionContent` metadata on the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span> <span class="o">=</span> <span class="n">SubmissionContent</span><span class="p">(</span>
            <span class="n">checksum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checksum</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">uncompressed_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uncompressed_size</span><span class="p">,</span>
            <span class="n">compressed_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span><span class="p">,</span>
            <span class="n">source_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_format</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="UpdateUploadPackage"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UpdateUploadPackage">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UpdateUploadPackage</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the upload workspace on this submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;update the upload package&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;upload package updated&quot;</span>

    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">uncompressed_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">compressed_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">source_format</span><span class="p">:</span> <span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span> <span class="o">=</span> \
        <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make sure that `source_format` is an enum instance.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UpdateUploadPackage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_format</span> <span class="o">=</span> <span class="n">SubmissionContent</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_format</span><span class="p">)</span>

<div class="viewcode-block" id="UpdateUploadPackage.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UpdateUploadPackage.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data for :class:`.SetUploadPackage`.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateUploadPackage.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UpdateUploadPackage.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace :class:`.SubmissionContent` metadata on the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span><span class="o">.</span><span class="n">source_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_format</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span><span class="o">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checksum</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span><span class="o">.</span><span class="n">uncompressed_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncompressed_size</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span><span class="o">.</span><span class="n">compressed_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed_size</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="UnsetUploadPackage"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnsetUploadPackage">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UnsetUploadPackage</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unset the upload workspace for this submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;unset the upload package&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;upload package unset&quot;</span>

<div class="viewcode-block" id="UnsetUploadPackage.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnsetUploadPackage.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data for :class:`.UnsetUploadPackage`.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="UnsetUploadPackage.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnsetUploadPackage.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.source_content` to None.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">source_content</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="ConfirmCompiledPreview"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmCompiledPreview">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">ConfirmCompiledPreview</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Confirm that the submitter successfully compiled a preview.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;confirm submission preview is compiled&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;confirmed that submission preview was compiled&quot;</span>

<div class="viewcode-block" id="ConfirmCompiledPreview.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmCompiledPreview.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="ConfirmCompiledPreview.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmCompiledPreview.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.submitter_compiled_preview`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_compiled_preview</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="UnConfirmCompiledPreview"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnConfirmCompiledPreview">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UnConfirmCompiledPreview</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unconfirm that the submitter successfully compiled a preview.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;unconfirm submission preview is compiled&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;unconfirmed that submission preview was compiled&quot;</span>

<div class="viewcode-block" id="UnConfirmCompiledPreview.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnConfirmCompiledPreview.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="UnConfirmCompiledPreview.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnConfirmCompiledPreview.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.submitter_compiled_preview`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_compiled_preview</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="ConfirmPreview"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPreview">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">ConfirmPreview</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Confirm that the paper and abstract previews are acceptable.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;approve submission preview&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission preview approved&quot;</span>

<div class="viewcode-block" id="ConfirmPreview.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPreview.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data for :class:`.ConfirmPreview`.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">submission_is_not_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfirmPreview.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.ConfirmPreview.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.submitter_confirmed_preview`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitter_confirmed_preview</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="FinalizeSubmission"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.FinalizeSubmission">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FinalizeSubmission</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Send the submission to the queue for announcement.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;finalize submission for announcement&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission finalized&quot;</span>

    <span class="n">REQUIRED</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;creator&#39;</span><span class="p">,</span> <span class="s1">&#39;primary_classification&#39;</span><span class="p">,</span> <span class="s1">&#39;submitter_contact_verified&#39;</span><span class="p">,</span>
        <span class="s1">&#39;submitter_accepts_policy&#39;</span><span class="p">,</span> <span class="s1">&#39;license&#39;</span><span class="p">,</span> <span class="s1">&#39;source_content&#39;</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">REQUIRED_METADATA</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;authors_display&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="FinalizeSubmission.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.FinalizeSubmission.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure that all required data/steps are complete.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_finalized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Submission already finalized&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Submission must be active&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required_fields_are_complete</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span></div>

<div class="viewcode-block" id="FinalizeSubmission.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.FinalizeSubmission.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.is_finalized`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">SUBMITTED</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitted</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div>

    <span class="k">def</span> <span class="nf">_required_fields_are_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify that all required fields are complete.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Missing </span><span class="si">{key}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_METADATA</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Missing </span><span class="si">{key}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnFinalizeSubmission"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnFinalizeSubmission">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UnFinalizeSubmission</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Withdraw the submission from the queue for announcement.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;re-open submission for modification&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission re-opened for modification&quot;</span>

<div class="viewcode-block" id="UnFinalizeSubmission.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnFinalizeSubmission.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the unfinalize action.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must_be_finalized</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_announced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Cannot unfinalize an announced paper&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_must_be_finalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;May only unfinalize a finalized submission.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submission</span><span class="o">.</span><span class="n">is_finalized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Submission is not finalized&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="UnFinalizeSubmission.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.UnFinalizeSubmission.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`Submission.is_finalized`.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">WORKING</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">submitted</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="Announce"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Announce">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">Announce</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Announce the current version of the submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;publish submission&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission announced&quot;</span>

    <span class="n">arxiv_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Announce.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Announce.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make sure that we have a valid arXiv ID.&quot;&quot;&quot;</span></div>
        <span class="c1"># TODO: When we&#39;re using this to perform publish in NG, we will want to</span>
        <span class="c1"># re-enable this step.</span>
        <span class="c1">#</span>
        <span class="c1"># if not submission.status == Submission.SUBMITTED:</span>
        <span class="c1">#     raise InvalidEvent(self,</span>
        <span class="c1">#                        &quot;Can&#39;t publish in state %s&quot; % submission.status)</span>
        <span class="c1"># if self.arxiv_id is None:</span>
        <span class="c1">#     raise InvalidEvent(self, &quot;Must provide an arXiv ID.&quot;)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     arxiv_identifier.parse_arxiv_id(self.arxiv_id)</span>
        <span class="c1"># except ValueError:</span>
        <span class="c1">#     raise InvalidEvent(self, &quot;Not a valid arXiv ID.&quot;)</span>

<div class="viewcode-block" id="Announce.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Announce.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the arXiv ID on the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">arxiv_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arxiv_id</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">ANNOUNCED</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">versions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">submission</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<span class="c1"># Moderation-related events.</span>


<span class="c1"># @dataclass()</span>
<span class="c1"># class CreateComment(Event):</span>
<span class="c1">#     &quot;&quot;&quot;Creation of a :class:`.Comment` on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     read_scope = &#39;submission:moderate&#39;</span>
<span class="c1">#     write_scope = &#39;submission:moderate&#39;</span>
<span class="c1">#</span>
<span class="c1">#     body: str = field(default_factory=str)</span>
<span class="c1">#     scope: str = &#39;private&#39;</span>
<span class="c1">#</span>
<span class="c1">#     def validate(self, submission: Submission) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;The :attr:`.body` should be set.&quot;&quot;&quot;</span>
<span class="c1">#         if not self.body:</span>
<span class="c1">#             raise ValueError(&#39;Comment body not set&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def project(self, submission: Submission) -&gt; Submission:</span>
<span class="c1">#         &quot;&quot;&quot;Create a new :class:`.Comment` and attach it to the submission.&quot;&quot;&quot;</span>
<span class="c1">#         submission.comments[self.event_id] = Comment(</span>
<span class="c1">#             event_id=self.event_id,</span>
<span class="c1">#             creator=self.creator,</span>
<span class="c1">#             created=self.created,</span>
<span class="c1">#             proxy=self.proxy,</span>
<span class="c1">#             submission=submission,</span>
<span class="c1">#             body=self.body</span>
<span class="c1">#         )</span>
<span class="c1">#         return submission</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @dataclass()</span>
<span class="c1"># class DeleteComment(Event):</span>
<span class="c1">#     &quot;&quot;&quot;Deletion of a :class:`.Comment` on a :class:`.domain.submission.Submission`.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     read_scope = &#39;submission:moderate&#39;</span>
<span class="c1">#     write_scope = &#39;submission:moderate&#39;</span>
<span class="c1">#</span>
<span class="c1">#     comment_id: str = field(default_factory=str)</span>
<span class="c1">#</span>
<span class="c1">#     def validate(self, submission: Submission) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;The :attr:`.comment_id` must present on the submission.&quot;&quot;&quot;</span>
<span class="c1">#         if self.comment_id is None:</span>
<span class="c1">#             raise InvalidEvent(self, &#39;comment_id is required&#39;)</span>
<span class="c1">#         if not hasattr(submission, &#39;comments&#39;) or not submission.comments:</span>
<span class="c1">#             raise InvalidEvent(self, &#39;Cannot delete nonexistant comment&#39;)</span>
<span class="c1">#         if self.comment_id not in submission.comments:</span>
<span class="c1">#             raise InvalidEvent(self, &#39;Cannot delete nonexistant comment&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def project(self, submission: Submission) -&gt; Submission:</span>
<span class="c1">#         &quot;&quot;&quot;Remove the comment from the submission.&quot;&quot;&quot;</span>
<span class="c1">#         del submission.comments[self.comment_id]</span>
<span class="c1">#         return submission</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @dataclass()</span>
<span class="c1"># class AddDelegate(Event):</span>
<span class="c1">#     &quot;&quot;&quot;Owner delegates authority to another agent.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     delegate: Optional[Agent] = None</span>
<span class="c1">#</span>
<span class="c1">#     def validate(self, submission: Submission) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;The event creator must be the owner of the submission.&quot;&quot;&quot;</span>
<span class="c1">#         if not self.creator == submission.owner:</span>
<span class="c1">#             raise InvalidEvent(self, &#39;Event creator must be submission owner&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def project(self, submission: Submission) -&gt; Submission:</span>
<span class="c1">#         &quot;&quot;&quot;Add the delegate to the submission.&quot;&quot;&quot;</span>
<span class="c1">#         delegation = Delegation(</span>
<span class="c1">#             creator=self.creator,</span>
<span class="c1">#             delegate=self.delegate,</span>
<span class="c1">#             created=self.created</span>
<span class="c1">#         )</span>
<span class="c1">#         submission.delegations[delegation.delegation_id] = delegation</span>
<span class="c1">#         return submission</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @dataclass()</span>
<span class="c1"># class RemoveDelegate(Event):</span>
<span class="c1">#     &quot;&quot;&quot;Owner revokes authority from another agent.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     delegation_id: str = field(default_factory=str)</span>
<span class="c1">#</span>
<span class="c1">#     def validate(self, submission: Submission) -&gt; None:</span>
<span class="c1">#         &quot;&quot;&quot;The event creator must be the owner of the submission.&quot;&quot;&quot;</span>
<span class="c1">#         if not self.creator == submission.owner:</span>
<span class="c1">#             raise InvalidEvent(self, &#39;Event creator must be submission owner&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def project(self, submission: Submission) -&gt; Submission:</span>
<span class="c1">#         &quot;&quot;&quot;Remove the delegate from the submission.&quot;&quot;&quot;</span>
<span class="c1">#         if self.delegation_id in submission.delegations:</span>
<span class="c1">#             del submission.delegations[self.delegation_id]</span>
<span class="c1">#         return submission</span>


<div class="viewcode-block" id="AddFeature"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddFeature">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">AddFeature</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add feature metadata to a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;add feature metadata&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;feature metadata added&quot;</span>

    <span class="n">feature_type</span><span class="p">:</span> <span class="n">Feature</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> \
        <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">Feature</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">WORD_COUNT</span><span class="p">)</span>
    <span class="n">feature_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="AddFeature.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddFeature.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify that the feature type is a known value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Feature</span><span class="o">.</span><span class="n">Type</span><span class="p">:</span>
            <span class="n">valid_types</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ft</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">Feature</span><span class="o">.</span><span class="n">Type</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Must be one of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">valid_types</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddFeature.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddFeature.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the annotation to the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span>
            <span class="n">event_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
            <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span>
            <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
            <span class="n">proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">feature_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_type</span><span class="p">,</span>
            <span class="n">feature_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_value</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="AddClassifierResults"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddClassifierResults">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">AddClassifierResults</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add the results of a classifier to a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;add classifer results&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;classifier results added&quot;</span>

    <span class="n">classifier</span><span class="p">:</span> <span class="n">ClassifierResults</span><span class="o">.</span><span class="n">Classifiers</span> \
        <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">ClassifierResults</span><span class="o">.</span><span class="n">Classifiers</span><span class="o">.</span><span class="n">CLASSIC</span><span class="p">)</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ClassifierResult</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

<div class="viewcode-block" id="AddClassifierResults.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddClassifierResults.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify that the classifier is a known value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ClassifierResults</span><span class="o">.</span><span class="n">Classifiers</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ClassifierResults</span><span class="o">.</span><span class="n">Classifiers</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Must be one of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">valid</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddClassifierResults.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.AddClassifierResults.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the annotation to the submission.&quot;&quot;&quot;</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClassifierResults</span><span class="p">(</span>
            <span class="n">event_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
            <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span>
            <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
            <span class="n">proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">classifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">,</span>
            <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>


<div class="viewcode-block" id="Reclassify"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Reclassify">[docs]</a><span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">Reclassify</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reclassify a submission.&quot;&quot;&quot;</span>

    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;reclassify submission&quot;</span>
    <span class="n">NAMED</span> <span class="o">=</span> <span class="s2">&quot;submission reclassified&quot;</span>

    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">taxonomy</span><span class="o">.</span><span class="n">Category</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Reclassify.validate"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Reclassify.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the primary classification category.&quot;&quot;&quot;</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">must_be_a_valid_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_must_be_unannounced</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
        <span class="n">validators</span><span class="o">.</span><span class="n">cannot_be_secondary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">submission</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_must_be_unannounced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Can only be set on the first version before publication.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">arxiv_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">submission</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Can only be set on the first version,&quot;</span>
                                     <span class="s2">&quot; before publication.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Reclassify.project"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.domain.event.html#arxiv.submission.domain.event.Reclassify.project">[docs]</a>    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Submission</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set :attr:`.domain.Submission.primary_classification`.&quot;&quot;&quot;</span>
        <span class="n">clsn</span> <span class="o">=</span> <span class="n">Classification</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">primary_classification</span> <span class="o">=</span> <span class="n">clsn</span>
        <span class="k">return</span> <span class="n">submission</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">arXiv submission & moderation</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Submission &amp; moderation subsystem architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../announcement_process.html">Submission &amp; announcement process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../submission_api_context.html">Submission API: Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arxiv.submission/arxiv.submission.html">arxiv.submission package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers/agent/agent.html">agent package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers/metadata/metadata.html">metadata package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../background.html">Background</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../submission.html">arxiv.submission</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, arXiv.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>